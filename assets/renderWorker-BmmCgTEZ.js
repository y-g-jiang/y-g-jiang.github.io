function k(u){const[[t,s,e],[l,a,i],[n,f,M]]=u,w=t*(a*M-i*f)-s*(l*M-i*n)+e*(l*f-a*n);if(Math.abs(w)<1e-10)return null;const c=1/w;return[[(a*M-i*f)*c,(e*f-s*M)*c,(s*i-e*a)*c],[(i*n-l*M)*c,(t*M-e*n)*c,(e*l-t*i)*c],[(l*f-a*n)*c,(s*n-t*f)*c,(t*a-s*l)*c]]}function G(u,t){const s=[[0,0,0],[0,0,0],[0,0,0]];for(let e=0;e<3;e++)for(let l=0;l<3;l++)for(let a=0;a<3;a++)s[e][l]+=u[e][a]*t[a][l];return s}let I=null;async function L(){if(!I)try{const e=(await import("./joraw-DBDL-TL5.js")).default;if(typeof e!="function")throw new Error("JoRaw WASM import failed");const l=new URL("/assets/joraw-BUh50ws_.wasm",import.meta.url).href;I=e({locateFile:(a,i)=>a.endsWith("joraw.wasm")?l:i+a})}catch(s){throw console.error("Failed to load joraw.js:",s),s}const u=await I,t=u.LibRaw||u.JoRaw;if(!t)throw new Error("JoRaw class not found");return t}const D=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]],g=u=>u<=.0031308?12.92*u:1.055*Math.pow(u,1/2.4)-.055;async function j(u,t){const s=await L(),e=new s;try{const l=new Uint8Array(u.slice(0));let a=!1,i=[];if(t.customMatrix&&t.customMatrix.length===9){const r=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],o=k(r);if(o){const y=t.wbGains?t.wbGains[0]:1,h=t.wbGains?t.wbGains[1]:1,R=G(o,[[y,0,0],[0,1,0],[0,0,h]]),d=G(D,R);i=[d[0][0],d[0][1],d[0][2],d[1][0],d[1][1],d[1][2],d[2][0],d[2][1],d[2][2]],a=!0}else throw new Error("Custom Matrix is not invertible.")}const n={outputBps:16,noAutoBright:!0,bright:a?1:Math.pow(2,t.exposure)};t.blackLevel&&t.blackLevel.length===4&&(n.userBlack=0,n.userCblack=t.blackLevel.map(r=>{const o=Math.round(r);return o===0?1:o})),t.demosaicMethod===-1?n.noInterpolation=!0:n.userQual=t.demosaicMethod,a?(n.outputColor=0,n.gamma=[1,1],n.userMul=[1,1,1,1],n.useCameraWb=!1):(n.outputColor=1,n.useCameraWb=!0),await e.open(l,n);const f=await e.imageData(),M=new ImageData(f.width,f.height),w=M.data,c=new Uint16Array(f.data.buffer,f.data.byteOffset,f.data.byteLength/2);if(a&&i.length===9){const r=i,y=Math.pow(2,t.exposure)*.25;for(let h=0;h<c.length;h+=3){const v=c[h]/65535,R=c[h+1]/65535,d=c[h+2]/65535;let x=r[0]*v+r[1]*R+r[2]*d,m=r[3]*v+r[4]*R+r[5]*d,b=r[6]*v+r[7]*R+r[8]*d;x*=y,m*=y,b*=y,x=Math.max(0,Math.min(1,x)),m=Math.max(0,Math.min(1,m)),b=Math.max(0,Math.min(1,b)),x=g(x),m=g(m),b=g(b);const p=h/3*4;w[p]=Math.round(x*255),w[p+1]=Math.round(m*255),w[p+2]=Math.round(b*255),w[p+3]=255}}else for(let r=0;r<c.length;r+=3){const o=r/3*4;w[o]=c[r]>>8,w[o+1]=c[r+1]>>8,w[o+2]=c[r+2]>>8,w[o+3]=255}return M}finally{e.delete?e.delete():e.close()}}async function J(u,t){const s=await L(),e=new s;try{await e.open(new Uint8Array(u));let l=16383;try{const o=await e.metadata(!0);o&&o.white_level&&(l=o.white_level)}catch(o){console.warn("Metadata error",o)}const a=e.getRawImage(),i=a.width,n=a.height,f=a.data,M=new ImageData(i,n),w=M.data,c=t.blackLevel||[0,0,0,0],r=l;for(let o=0;o<n;o++){const y=o%2;for(let h=0;h<i;h++){const v=h%2,R=y*2+v,d=f[o*i+h],x=c[R];let m=(d-x)/(r-x);m=Math.max(0,Math.min(1,m)),t.exposure!==0&&(m*=Math.pow(2,t.exposure),m=Math.min(1,m));let b=0;m<=.0031308?b=12.92*m:b=1.055*Math.pow(m,1/2.4)-.055;const p=Math.round(b*255),C=(o*i+h)*4;w[C]=p,w[C+1]=p,w[C+2]=p,w[C+3]=255}}return M}finally{e.delete?e.delete():e.close()}}self.onmessage=async u=>{const{buffer:t,settings:s}=u.data;try{let e;s.renderMode==="zero-dependency"?e=await J(t,s):e=await j(t,s),self.postMessage({success:!0,imageData:e},[e.data.buffer])}catch(e){self.postMessage({success:!1,error:e.message})}};
