(function(){"use strict";var F=class{constructor(){this.worker=new Worker(new URL("/assets/worker-BoSvDwZW.js",self.location.href),{type:"module"}),this.waitForWorker=!1,this.worker.onmessage=({data:r})=>{if(this.waitForWorker){let{return:t,throw:n}=this.waitForWorker;this.waitForWorker=!1,r!=null&&r.error?n(r.error):t(r==null?void 0:r.out)}}}async runFn(r,...t){let n=new Promise((e,o)=>{this.waitForWorker={error:o,return:e}});return this.worker.postMessage({fn:r,args:t},t.map(e=>{if([ArrayBuffer,Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].some(o=>e instanceof o))return e.buffer}).filter(e=>e)),await n}async open(r,t){return await this.runFn("open",r,t)}async metadata(r){let t=await this.runFn("metadata",!!r);return t!=null&&t.hasOwnProperty("thumb_format")&&(t.thumb_format=["unknown","jpeg","bitmap","bitmap16","layer","rollei","h265"][t.thumb_format]||"unknown"),t!=null&&t.hasOwnProperty("desc")&&(t.desc=String(t.desc).trim()),t!=null&&t.hasOwnProperty("timestamp")&&(t.timestamp=new Date(t.timestamp)),t}async imageData(){return await this.runFn("imageData")}};function g(r){const[[t,n,e],[o,c,s],[m,h,u]]=r,f=t*(c*u-s*h)-n*(o*u-s*m)+e*(o*h-c*m);if(Math.abs(f)<1e-10)return null;const a=1/f;return[[(c*u-s*h)*a,(e*h-n*u)*a,(n*s-e*c)*a],[(s*m-o*u)*a,(t*u-e*m)*a,(e*o-t*s)*a],[(o*h-c*m)*a,(n*m-t*h)*a,(t*c-n*o)*a]]}function A(r,t){const n=[[0,0,0],[0,0,0],[0,0,0]];for(let e=0;e<3;e++)for(let o=0;o<3;o++)for(let c=0;c<3;c++)n[e][o]+=r[e][c]*t[c][o];return n}const v=r=>{r&&typeof r.close=="function"&&r.close()},D=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]],k=r=>r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055;async function G(r,t){const n=new F;try{const e=new Uint8Array(r.slice(0));let o=!1,c=[];if(t.customMatrix&&t.customMatrix.length===9){const a=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],l=g(a);if(l){const w=t.wbGains?t.wbGains[0]:1,b=t.wbGains?t.wbGains[1]:1,p=A(l,[[w,0,0],[0,1,0],[0,0,b]]),i=A(D,p);c=[i[0][0],i[0][1],i[0][2],i[1][0],i[1][1],i[1][2],i[2][0],i[2][1],i[2][2]],o=!0}else console.warn("Provided custom matrix is singular and cannot be inverted.")}const s={outputBps:16,noAutoBright:!0,bright:o?1:Math.pow(2,t.exposure)};t.blackLevel&&t.blackLevel.length===4&&(s.userBlack=0,s.userCblack=t.blackLevel.map(a=>{const l=Math.round(a);return l===0?1:l})),t.demosaicMethod===-1?s.noInterpolation=!0:s.userQual=t.demosaicMethod,o?(s.outputColor=0,s.gamma=[1,1],s.userMul=[1,1,1,1],s.useCameraWb=!1):(s.outputColor=1,s.useCameraWb=!0),await n.open(e,s);const m=await n.imageData(),h=new ImageData(m.width,m.height),u=h.data,f=new Uint16Array(m.data.buffer,m.data.byteOffset,m.data.byteLength/2);if(o&&c.length===9){const a=c,l=Math.pow(2,t.exposure);for(let w=0;w<f.length;w+=3){const b=f[w]/65535,y=f[w+1]/65535,p=f[w+2]/65535;let i=a[0]*b+a[1]*y+a[2]*p,d=a[3]*b+a[4]*y+a[5]*p,M=a[6]*b+a[7]*y+a[8]*p;i*=l,d*=l,M*=l,i=Math.max(0,Math.min(1,i)),d=Math.max(0,Math.min(1,d)),M=Math.max(0,Math.min(1,M)),i=k(i),d=k(d),M=k(M);const x=w/3*4;u[x]=Math.round(i*255),u[x+1]=Math.round(d*255),u[x+2]=Math.round(M*255),u[x+3]=255}}else for(let a=0;a<f.length;a+=3){const l=a/3*4;u[l]=f[a]>>8,u[l+1]=f[a+1]>>8,u[l+2]=f[a+2]>>8,u[l+3]=255}return h}finally{v(n)}}self.onmessage=async r=>{const{buffer:t,settings:n}=r.data;try{const e=await G(t,n);self.postMessage({success:!0,imageData:e},[e.data.buffer])}catch(e){self.postMessage({success:!1,error:e.message})}}})();
