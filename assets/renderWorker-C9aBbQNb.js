function j(u){const[[t,n,a],[l,e,i],[r,m,M]]=u,w=t*(e*M-i*m)-n*(l*M-i*r)+a*(l*m-e*r);if(Math.abs(w)<1e-10)return null;const c=1/w;return[[(e*M-i*m)*c,(a*m-n*M)*c,(n*i-a*e)*c],[(i*r-l*M)*c,(t*M-a*r)*c,(a*l-t*i)*c],[(l*m-e*r)*c,(n*r-t*m)*c,(t*e-n*l)*c]]}function k(u,t){const n=[[0,0,0],[0,0,0],[0,0,0]];for(let a=0;a<3;a++)for(let l=0;l<3;l++)for(let e=0;e<3;e++)n[a][l]+=u[a][e]*t[e][l];return n}let L=null;async function D(){if(!L)try{const a=(await import("./joraw-DBDL-TL5.js")).default;if(typeof a!="function")throw new Error("JoRaw WASM import failed");const l=new URL("/assets/joraw-BUh50ws_.wasm",import.meta.url).href;L=a({locateFile:(e,i)=>e.endsWith("joraw.wasm")?l:i+e})}catch(n){throw console.error("Failed to load joraw.js:",n),n}const u=await L,t=u.LibRaw||u.JoRaw;if(!t)throw new Error("JoRaw class not found");return t}const J=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]],C=u=>u<=.0031308?12.92*u:1.055*Math.pow(u,1/2.4)-.055;async function B(u,t){const n=await D(),a=new n;try{const l=new Uint8Array(u.slice(0));let e=!1,i=[];if(t.customMatrix&&t.customMatrix.length===9){const o=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],f=j(o);if(f){const G=t.wbGains?t.wbGains[0]:1,s=t.wbGains?t.wbGains[1]:1,b=k(f,[[G,0,0],[0,1,0],[0,0,s]]),d=k(J,b);i=[d[0][0],d[0][1],d[0][2],d[1][0],d[1][1],d[1][2],d[2][0],d[2][1],d[2][2]],e=!0}else throw new Error("Custom Matrix is not invertible.")}const r={outputBps:16,noAutoBright:!0,bright:e?1:Math.pow(2,t.exposure)};t.blackLevel&&t.blackLevel.length===4&&(r.userBlack=0,r.userCblack=t.blackLevel.map(o=>{const f=Math.round(o);return f===0?1:f})),t.demosaicMethod===-1?r.noInterpolation=!0:r.userQual=t.demosaicMethod,e?(r.outputColor=0,r.gamma=[1,1],r.userMul=[1,1,1,1],r.useCameraWb=!1):(r.outputColor=1,r.useCameraWb=!0),await a.open(l,r);const m=await a.imageData(),M=new ImageData(m.width,m.height),w=M.data,c=new Uint16Array(m.data.buffer,m.data.byteOffset,m.data.byteLength/2);if(e&&i.length===9){const o=i,G=Math.pow(2,t.exposure)*.25;for(let s=0;s<c.length;s+=3){const R=c[s]/65535,b=c[s+1]/65535,d=c[s+2]/65535;let x=o[0]*R+o[1]*b+o[2]*d,y=o[3]*R+o[4]*b+o[5]*d,p=o[6]*R+o[7]*b+o[8]*d;x*=G,y*=G,p*=G,x=Math.max(0,Math.min(1,x)),y=Math.max(0,Math.min(1,y)),p=Math.max(0,Math.min(1,p)),x=C(x),y=C(y),p=C(p);const h=s/3*4;w[h]=Math.round(x*255),w[h+1]=Math.round(y*255),w[h+2]=Math.round(p*255),w[h+3]=255}}else for(let o=0;o<c.length;o+=3){const f=o/3*4;w[f]=c[o]>>8,w[f+1]=c[o+1]>>8,w[f+2]=c[o+2]>>8,w[f+3]=255}return M}finally{a.delete?a.delete():a.close()}}async function U(u,t){const n=await D(),a=new n;try{await a.open(new Uint8Array(u));let l=16383;try{const s=await a.metadata(!0);s&&s.white_level&&(l=s.white_level)}catch(s){console.warn("Metadata error",s)}const e=a.getRawImage(),i=e.width,r=e.height,m=e.data,M=new ImageData(i,r),w=M.data,c=t.blackLevel||[0,0,0,0],o=l,f=t.wbGains?t.wbGains[0]:1,G=t.wbGains?t.wbGains[1]:1;for(let s=0;s<r;s++){const R=s%2;for(let b=0;b<i;b++){const d=b%2,x=R*2+d,y=m[s*i+b],p=c[x];let h=(y-p)/(o-p);h=Math.max(0,Math.min(1,h)),t.exposure!==0&&(h*=Math.pow(2,t.exposure),h=Math.min(1,h)),x===0?h*=f:x===3&&(h*=G);const I=Math.round(C(Math.min(1,h))*255),v=(s*i+b)*4;w[v]=I,w[v+1]=I,w[v+2]=I,w[v+3]=255}}return M}finally{a.delete?a.delete():a.close()}}self.onmessage=async u=>{const{buffer:t,settings:n}=u.data;try{let a;n.renderMode==="zero-dependency"?a=await U(t,n):a=await B(t,n),self.postMessage({success:!0,imageData:a},[a.data.buffer])}catch(a){self.postMessage({success:!1,error:a.message})}};
