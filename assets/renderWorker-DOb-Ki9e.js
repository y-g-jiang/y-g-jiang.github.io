function S(l){const[[t,s,a],[c,o,i],[r,m,d]]=l,w=t*(o*d-i*m)-s*(c*d-i*r)+a*(c*m-o*r);if(Math.abs(w)<1e-10)return null;const n=1/w;return[[(o*d-i*m)*n,(a*m-s*d)*n,(s*i-a*o)*n],[(i*r-c*d)*n,(t*d-a*r)*n,(a*c-t*i)*n],[(c*m-o*r)*n,(s*r-t*m)*n,(t*o-s*c)*n]]}function v(l,t){const s=[[0,0,0],[0,0,0],[0,0,0]];for(let a=0;a<3;a++)for(let c=0;c<3;c++)for(let o=0;o<3;o++)s[a][c]+=l[a][o]*t[o][c];return s}let G=null;async function j(){if(!G)try{const a=(await import("./joraw-DBDL-TL5.js")).default;if(typeof a!="function")throw console.error("JoRaw import error:",a),new Error("JoRaw WASM import is not a function. Check your path or build flags.");const c=new URL("/assets/joraw-BUh50ws_.wasm",import.meta.url).href;G=a({locateFile:(o,i)=>o.endsWith("joraw.wasm")?c:i+o})}catch(s){throw console.error("Failed to load joraw.js:",s),s}const l=await G,t=l.LibRaw||l.JoRaw;if(!t)throw new Error("JoRaw class (or underlying LibRaw) not found in WASM module. Check EMSCRIPTEN_BINDINGS.");return t}const B=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]],k=l=>l<=.0031308?12.92*l:1.055*Math.pow(l,1/2.4)-.055;async function D(l,t){const s=await j(),a=new s;try{const c=new Uint8Array(l.slice(0));let o=!1,i=[];if(t.customMatrix&&t.customMatrix.length===9){const e=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],f=S(e);if(f){const p=t.wbGains?t.wbGains[0]:1,M=t.wbGains?t.wbGains[1]:1,y=v(f,[[p,0,0],[0,1,0],[0,0,M]]),u=v(B,y);i=[u[0][0],u[0][1],u[0][2],u[1][0],u[1][1],u[1][2],u[2][0],u[2][1],u[2][2]],o=!0}else throw new Error("Custom Matrix is not invertible (determinant is zero). Please check your values.")}const r={outputBps:16,noAutoBright:!0,bright:o?1:Math.pow(2,t.exposure)};t.blackLevel&&t.blackLevel.length===4&&(r.userBlack=0,r.userCblack=t.blackLevel.map(e=>{const f=Math.round(e);return f===0?1:f})),t.demosaicMethod===-1?r.noInterpolation=!0:r.userQual=t.demosaicMethod,o?(r.outputColor=0,r.gamma=[1,1],r.userMul=[1,1,1,1],r.useCameraWb=!1):(r.outputColor=1,r.useCameraWb=!0),await a.open(c,r);const m=await a.imageData(),d=new ImageData(m.width,m.height),w=d.data,n=new Uint16Array(m.data.buffer,m.data.byteOffset,m.data.byteLength/2);if(o&&i.length===9){const e=i,p=Math.pow(2,t.exposure)*.25;for(let M=0;M<n.length;M+=3){const R=n[M]/65535,y=n[M+1]/65535,u=n[M+2]/65535;let h=e[0]*R+e[1]*y+e[2]*u,b=e[3]*R+e[4]*y+e[5]*u,x=e[6]*R+e[7]*y+e[8]*u;h*=p,b*=p,x*=p,h=Math.max(0,Math.min(1,h)),b=Math.max(0,Math.min(1,b)),x=Math.max(0,Math.min(1,x)),h=k(h),b=k(b),x=k(x);const C=M/3*4;w[C]=Math.round(h*255),w[C+1]=Math.round(b*255),w[C+2]=Math.round(x*255),w[C+3]=255}}else for(let e=0;e<n.length;e+=3){const f=e/3*4;w[f]=n[e]>>8,w[f+1]=n[e+1]>>8,w[f+2]=n[e+2]>>8,w[f+3]=255}return d}finally{a.delete?a.delete():a.close()}}self.onmessage=async l=>{const{buffer:t,settings:s}=l.data;try{const a=await D(t,s);self.postMessage({success:!0,imageData:a},[a.data.buffer])}catch(a){self.postMessage({success:!1,error:a.message})}};
