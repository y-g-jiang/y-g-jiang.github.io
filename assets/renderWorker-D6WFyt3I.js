function G(f){const[[t,s,a],[c,e,i],[r,m,d]]=f,w=t*(e*d-i*m)-s*(c*d-i*r)+a*(c*m-e*r);if(Math.abs(w)<1e-10)return null;const n=1/w;return[[(e*d-i*m)*n,(a*m-s*d)*n,(s*i-a*e)*n],[(i*r-c*d)*n,(t*d-a*r)*n,(a*c-t*i)*n],[(c*m-e*r)*n,(s*r-t*m)*n,(t*e-s*c)*n]]}function k(f,t){const s=[[0,0,0],[0,0,0],[0,0,0]];for(let a=0;a<3;a++)for(let c=0;c<3;c++)for(let e=0;e<3;e++)s[a][c]+=f[a][e]*t[e][c];return s}let C=null;async function j(){if(!C)try{const a=(await import("./joraw-DBDL-TL5.js")).default;if(typeof a!="function")throw console.error("JoRaw import error:",a),new Error("JoRaw WASM import is not a function. Check your path or build flags.");const c=new URL("/assets/joraw-BUh50ws_.wasm",import.meta.url).href;C=a({locateFile:(e,i)=>e.endsWith("joraw.wasm")?c:i+e})}catch(s){throw console.error("Failed to load joraw.js:",s),s}const f=await C,t=f.LibRaw||f.JoRaw;if(!t)throw new Error("JoRaw class (or underlying LibRaw) not found in WASM module. Check EMSCRIPTEN_BINDINGS.");return t}const D=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];async function I(f,t){const s=await j(),a=new s;try{const c=new Uint8Array(f.slice(0));let e=!1,i=[];if(t.customMatrix&&t.customMatrix.length===9){const o=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],l=G(o);if(l){const M=t.wbGains?t.wbGains[0]:1,h=t.wbGains?t.wbGains[1]:1,b=k(l,[[M,0,0],[0,1,0],[0,0,h]]),u=k(D,b);i=[u[0][0],u[0][1],u[0][2],u[1][0],u[1][1],u[1][2],u[2][0],u[2][1],u[2][2]],e=!0}}const r={outputBps:16,noAutoBright:!0,bright:e?1:Math.pow(2,t.exposure)};t.blackLevel&&t.blackLevel.length===4&&(r.userBlack=0,r.userCblack=t.blackLevel.map(o=>{const l=Math.round(o);return l===0?1:l})),t.demosaicMethod===-1?r.noInterpolation=!0:r.userQual=t.demosaicMethod,e?(r.outputColor=0,r.gamma=[1,1],r.userMul=[1,1,1,1],r.useCameraWb=!1):(r.outputColor=1,r.useCameraWb=!0),await a.open(c,r);const m=await a.imageData(),d=new ImageData(m.width,m.height),w=d.data,n=new Uint16Array(m.data.buffer,m.data.byteOffset,m.data.byteLength/2);if(e&&i.length===9){const o=i,l=Math.pow(2,t.exposure);for(let M=0;M<n.length;M+=3){const h=n[M]/65535,x=n[M+1]/65535,b=n[M+2]/65535;let u=o[0]*h+o[1]*x+o[2]*b,p=o[3]*h+o[4]*x+o[5]*b,y=o[6]*h+o[7]*x+o[8]*b;u*=l,p*=l,y*=l,u=Math.max(0,Math.min(1,u)),p=Math.max(0,Math.min(1,p)),y=Math.max(0,Math.min(1,y));const R=M/3*4;w[R]=Math.round(u*255),w[R+1]=Math.round(p*255),w[R+2]=Math.round(y*255),w[R+3]=255}}else for(let o=0;o<n.length;o+=3){const l=o/3*4;w[l]=n[o]>>8,w[l+1]=n[o+1]>>8,w[l+2]=n[o+2]>>8,w[l+3]=255}return d}finally{a.delete?a.delete():a.close()}}self.onmessage=async f=>{const{buffer:t,settings:s}=f.data;try{const a=await I(t,s);self.postMessage({success:!0,imageData:a},[a.data.buffer])}catch(a){self.postMessage({success:!1,error:a.message})}};
