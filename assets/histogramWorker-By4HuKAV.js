let A=null;async function J(){if(!A)try{const c=(await import("./joraw-DBDL-TL5.js")).default;if(typeof c!="function")throw new Error("JoRaw WASM import failed");const w=new URL("/assets/joraw-BUh50ws_.wasm",import.meta.url).href;A=c({locateFile:(f,d)=>f.endsWith("joraw.wasm")?w:d+f})}catch(a){throw console.error("Failed to load joraw.js:",a),a}const n=await A,r=n.LibRaw||n.JoRaw;if(!r)throw new Error("JoRaw class not found");return r}const L=async n=>{var c,w,f,d,l,s,y,_,M;const r=await J(),a=new r;try{if(await a.open(n,{}),typeof a.getRawImage!="function")throw new Error("WASM mismatch");const g=a.getRawImage();let v=new Uint16Array(g.data);const t=await a.metadata(!0),m=((c=t.idata)==null?void 0:c.filters)||0,i=((w=t.idata)==null?void 0:w.colors)||0,k=m===0&&i===3,u=m===9;let o=[];if((f=t.color_data)!=null&&f.cblack_rawpy_style)o=t.color_data.cblack_rawpy_style;else if((l=(d=t.color_data)==null?void 0:d.dng_levels)!=null&&l.dng_cblack)o=t.color_data.dng_levels.dng_cblack;else if(((s=t.black_level_per_channel)==null?void 0:s.length)>=4)o=t.black_level_per_channel;else if(((y=t.cblack)==null?void 0:y.length)>=4)o=t.cblack;else if(((M=(_=t.color)==null?void 0:_.cblack)==null?void 0:M.length)>=4)o=t.color.cblack;else{const h=t.black_level||t.color_data&&t.color_data.black||0;o=[h,h,h,h]}const e=[Number(o[0])||0,Number(o[1])||0,Number(o[2])||0,Number(o[3])||0];return{data:v,width:g.width,height:g.height,bayerPattern:t.color_desc||"RGGB",blackLevels:e,whiteLevel:t.white_level||16383,metadata:t,isThreePlane:k,isXTrans:u}}finally{a.delete?a.delete():a.close()}};async function j(n){const r=new Uint8Array(n);return L(r)}function x(n,r,a,c,w,f,d,l,s,y,_){if(y<=s)return[];const M=Math.max(0,Math.floor(c)),g=Math.max(0,Math.floor(w)),v=Math.min(r,Math.ceil(c+f)),t=Math.min(a,Math.ceil(w+d)),m=y-s,i=_?Math.floor(m)+1:l,k=m/i,u=[new Uint32Array(i),new Uint32Array(i),new Uint32Array(i),new Uint32Array(i)];for(let e=g;e<t;e++){const h=e*r,U=e%2;for(let p=M;p<v;p++){const I=p%2,R=n[h+p];if(R<s||R>y)continue;const B=U*2+I;let b;_?b=Math.floor(R-s):b=Math.floor((R-s)/k),b<0&&(b=0),b>=i&&(b=i-1),u[B][b]++}}const o=[];for(let e=0;e<i;e++){const h=s+(_?e:e*k);o.push({binStart:h,c0:u[0][e],c1:u[1][e],c2:u[2][e],c3:u[3][e]})}return o}self.onmessage=async n=>{const{buffer:r,roi:a,binCount:c,minVal:w,maxVal:f,pointToPoint:d}=n.data;try{const l=await j(r),s=x(l.data,l.width,l.height,a.x,a.y,a.w,a.h,c,w,f,d);self.postMessage({success:!0,hist:s})}catch(l){self.postMessage({success:!1,error:l.message})}};
