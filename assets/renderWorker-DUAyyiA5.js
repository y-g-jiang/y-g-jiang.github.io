function W(u){const[[e,r,t],[i,o,s],[n,h,b]]=u,d=e*(o*b-s*h)-r*(i*b-s*n)+t*(i*h-o*n);if(Math.abs(d)<1e-10)return null;const l=1/d;return[[(o*b-s*h)*l,(t*h-r*b)*l,(r*s-t*o)*l],[(s*n-i*b)*l,(e*b-t*n)*l,(t*i-e*s)*l],[(i*h-o*n)*l,(r*n-e*h)*l,(e*o-r*i)*l]]}function B(u,e){const r=[[0,0,0],[0,0,0],[0,0,0]];for(let t=0;t<3;t++)for(let i=0;i<3;i++)for(let o=0;o<3;o++)r[t][i]+=u[t][o]*e[o][i];return r}let j=null;async function A(){if(!j)try{const t=(await import("./joraw-DBDL-TL5.js")).default;if(typeof t!="function")throw new Error("JoRaw WASM import failed");const i=new URL("/assets/joraw-BUh50ws_.wasm",import.meta.url).href;j=t({locateFile:(o,s)=>o.endsWith("joraw.wasm")?i:s+o})}catch(r){throw console.error("Failed to load joraw.js:",r),r}const u=await j,e=u.LibRaw||u.JoRaw;if(!e)throw new Error("JoRaw class not found");return e}const z=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]],G=u=>u<=.0031308?12.92*u:1.055*Math.pow(u,1/2.4)-.055;async function O(u,e){const r=await A(),t=new r;try{const i=new Uint8Array(u.slice(0));let o=!1,s=[];if(e.customMatrix&&e.customMatrix.length===9){const a=[[e.customMatrix[0],e.customMatrix[1],e.customMatrix[2]],[e.customMatrix[3],e.customMatrix[4],e.customMatrix[5]],[e.customMatrix[6],e.customMatrix[7],e.customMatrix[8]]],f=W(a);if(f){const v=e.wbGains?e.wbGains[0]:1,c=e.wbGains?e.wbGains[1]:1,x=B(f,[[v,0,0],[0,1,0],[0,0,c]]),w=B(z,x);s=[w[0][0],w[0][1],w[0][2],w[1][0],w[1][1],w[1][2],w[2][0],w[2][1],w[2][2]],o=!0}else throw new Error("Custom Matrix is not invertible.")}const n={outputBps:16,noAutoBright:!0,bright:o?1:Math.pow(2,e.exposure)};e.blackLevel&&e.blackLevel.length===4&&(n.userBlack=0,n.userCblack=e.blackLevel.map(a=>{const f=Math.round(a);return f===0?1:f})),e.demosaicMethod===-1?n.noInterpolation=!0:n.userQual=e.demosaicMethod,o?(n.outputColor=0,n.gamma=[1,1],n.userMul=[1,1,1,1],n.useCameraWb=!1):(n.outputColor=1,n.useCameraWb=!0),await t.open(i,n);const h=await t.imageData(),b=new ImageData(h.width,h.height),d=b.data,l=new Uint16Array(h.data.buffer,h.data.byteOffset,h.data.byteLength/2);if(o&&s.length===9){const a=s,v=Math.pow(2,e.exposure)*.25;for(let c=0;c<l.length;c+=3){const m=l[c]/65535,x=l[c+1]/65535,w=l[c+2]/65535;let y=a[0]*m+a[1]*x+a[2]*w,M=a[3]*m+a[4]*x+a[5]*w,g=a[6]*m+a[7]*x+a[8]*w;y*=v,M*=v,g*=v,y=Math.max(0,Math.min(1,y)),M=Math.max(0,Math.min(1,M)),g=Math.max(0,Math.min(1,g)),y=G(y),M=G(M),g=G(g);const p=c/3*4;d[p]=Math.round(y*255),d[p+1]=Math.round(M*255),d[p+2]=Math.round(g*255),d[p+3]=255}}else for(let a=0;a<l.length;a+=3){const f=a/3*4;d[f]=l[a]>>8,d[f+1]=l[a+1]>>8,d[f+2]=l[a+2]>>8,d[f+3]=255}return b}finally{t.delete?t.delete():t.close()}}async function S(u,e){const r=await A(),t=new r;try{await t.open(new Uint8Array(u));let i=16383;try{const c=await t.metadata(!0);c&&c.white_level&&(i=c.white_level)}catch(c){console.warn("Metadata error",c)}const o=t.getRawImage(),s=o.width,n=o.height,h=o.data,b=new ImageData(s,n),d=b.data,l=e.blackLevel||[0,0,0,0],a=i,f=e.wbGains?e.wbGains[0]:1,v=e.wbGains?e.wbGains[1]:1;for(let c=0;c<n;c++){const m=c%2;for(let x=0;x<s;x++){const w=x%2,y=m*2+w,M=h[c*s+x],g=l[y];let p=(M-g)/(a-g);p=Math.max(0,Math.min(1,p)),e.exposure!==0&&(p*=Math.pow(2,e.exposure),p=Math.min(1,p)),y===0?p*=f:y===3&&(p*=v);const I=Math.round(G(Math.min(1,p))*255),R=(c*s+x)*4;d[R]=I,d[R+1]=I,d[R+2]=I,d[R+3]=255}}return b}finally{t.delete?t.delete():t.close()}}async function Z(u,e){const r=await A(),t=new r;try{await t.open(new Uint8Array(u));let i=16383;try{const m=await t.metadata(!0);m&&m.white_level&&(i=m.white_level)}catch(m){console.warn("Metadata error",m)}const o=t.getRawImage(),{width:s,height:n,data:h}=o,b=new ImageData(s,n),d=b.data;if(!e.advancedZeroDep)throw new Error("Missing advanced settings");const{bl:l,bg:a,fg:f}=e.advancedZeroDep,v=(a[1]+a[3])/2,c=(f[1]+f[3])/2;for(let m=0;m<n;m++){const x=m%2;for(let w=0;w<s;w++){const y=w%2;let M=0;!x&&!y?M=0:!x&&y?M=1:x&&!y?M=3:M=2;const g=h[m*s+w],p=l[M],I=a[M],R=f[M],L=Math.max(g-p,0),U=R-I||1e-9,_=(L-I)/U;let D;_<0?D=L*(v/Math.max(I,1e-9)):_>1?D=L*(c/Math.max(R,1e-9)):D=(1-_)*v+_*c;let k=D/i;k=Math.max(0,Math.min(1,k));const J=Math.round(G(k)*255),C=(m*s+w)*4;d[C]=J,d[C+1]=J,d[C+2]=J,d[C+3]=255}}return b}finally{t.delete?t.delete():t.close()}}self.onmessage=async u=>{const{buffer:e,settings:r}=u.data;try{let t;r.renderMode==="zero-dependency"?t=await S(e,r):r.renderMode==="advanced-zero-dep"?t=await Z(e,r):t=await O(e,r),self.postMessage({success:!0,imageData:t},[t.data.buffer])}catch(t){self.postMessage({success:!1,error:t.message})}};
