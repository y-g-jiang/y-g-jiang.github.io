function k(m){const[[t,n,a],[l,c,d],[o,u,M]]=m,f=t*(c*M-d*u)-n*(l*M-d*o)+a*(l*u-c*o);if(Math.abs(f)<1e-10)return null;const r=1/f;return[[(c*M-d*u)*r,(a*u-n*M)*r,(n*d-a*c)*r],[(d*o-l*M)*r,(t*M-a*o)*r,(a*l-t*d)*r],[(l*u-c*o)*r,(n*o-t*u)*r,(t*c-n*l)*r]]}function R(m,t){const n=[[0,0,0],[0,0,0],[0,0,0]];for(let a=0;a<3;a++)for(let l=0;l<3;l++)for(let c=0;c<3;c++)n[a][l]+=m[a][c]*t[c][l];return n}let L=null;async function G(){if(!L)try{const n=(await import("./libraw-WC0qXKjF.js")).default;if(typeof n!="function")throw console.error("LibRaw import error:",n),new Error("LibRaw WASM import is not a function. Check your path or build flags.");L=n()}catch(t){throw console.error("Failed to load libraw.js:",t),t}const m=await L;if(!m.LibRaw)throw new Error("LibRaw class not found in WASM module. Check EMSCRIPTEN_BINDINGS.");return m.LibRaw}const D=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]];async function I(m,t){const n=await G(),a=new n;try{const l=new Uint8Array(m.slice(0));let c=!1,d=[];if(t.customMatrix&&t.customMatrix.length===9){const e=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],s=k(e);if(s){const w=t.wbGains?t.wbGains[0]:1,b=t.wbGains?t.wbGains[1]:1,h=R(s,[[w,0,0],[0,1,0],[0,0,b]]),i=R(D,h);d=[i[0][0],i[0][1],i[0][2],i[1][0],i[1][1],i[1][2],i[2][0],i[2][1],i[2][2]],c=!0}}const o={outputBps:16,noAutoBright:!0,bright:c?1:Math.pow(2,t.exposure)};t.blackLevel&&t.blackLevel.length===4&&(o.userBlack=0,o.userCblack=t.blackLevel.map(e=>{const s=Math.round(e);return s===0?1:s})),t.demosaicMethod===-1?o.noInterpolation=!0:o.userQual=t.demosaicMethod,c?(o.outputColor=0,o.gamma=[1,1],o.userMul=[1,1,1,1],o.useCameraWb=!1):(o.outputColor=1,o.useCameraWb=!0),await a.open(l,o);const u=await a.imageData(),M=new ImageData(u.width,u.height),f=M.data,r=new Uint16Array(u.data.buffer,u.data.byteOffset,u.data.byteLength/2);if(c&&d.length===9){const e=d,s=Math.pow(2,t.exposure);for(let w=0;w<r.length;w+=3){const b=r[w]/65535,x=r[w+1]/65535,h=r[w+2]/65535;let i=e[0]*b+e[1]*x+e[2]*h,p=e[3]*b+e[4]*x+e[5]*h,y=e[6]*b+e[7]*x+e[8]*h;i*=s,p*=s,y*=s,i=Math.max(0,Math.min(1,i)),p=Math.max(0,Math.min(1,p)),y=Math.max(0,Math.min(1,y));const C=w/3*4;f[C]=Math.round(i*255),f[C+1]=Math.round(p*255),f[C+2]=Math.round(y*255),f[C+3]=255}}else for(let e=0;e<r.length;e+=3){const s=e/3*4;f[s]=r[e]>>8,f[s+1]=r[e+1]>>8,f[s+2]=r[e+2]>>8,f[s+3]=255}return M}finally{a.delete?a.delete():a.close()}}self.onmessage=async m=>{const{buffer:t,settings:n}=m.data;try{const a=await I(t,n);self.postMessage({success:!0,imageData:a},[a.data.buffer])}catch(a){self.postMessage({success:!1,error:a.message})}};
