function E(M){const[[t,l,a],[u,i,e],[c,p,y]]=M,d=t*(i*y-e*p)-l*(u*y-e*c)+a*(u*p-i*c);if(Math.abs(d)<1e-10)return null;const m=1/d;return[[(i*y-e*p)*m,(a*p-l*y)*m,(l*e-a*i)*m],[(e*c-u*y)*m,(t*y-a*c)*m,(a*u-t*e)*m],[(u*p-i*c)*m,(l*c-t*p)*m,(t*i-l*u)*m]]}function V(M,t){const l=[[0,0,0],[0,0,0],[0,0,0]];for(let a=0;a<3;a++)for(let u=0;u<3;u++)for(let i=0;i<3;i++)l[a][u]+=M[a][i]*t[i][u];return l}let T=null;async function F(){if(!T)try{const a=(await import("./joraw-DBDL-TL5.js")).default;if(typeof a!="function")throw new Error("JoRaw WASM import failed");const u=new URL("/assets/joraw-BUh50ws_.wasm",import.meta.url).href;T=a({locateFile:(i,e)=>i.endsWith("joraw.wasm")?u:e+i})}catch(l){throw console.error("Failed to load joraw.js:",l),l}const M=await T,t=M.LibRaw||M.JoRaw;if(!t)throw new Error("JoRaw class not found");return t}const X=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]],z=M=>M<=.0031308?12.92*M:1.055*Math.pow(M,1/2.4)-.055;async function P(M,t){const l=await F(),a=new l;try{const u=new Uint8Array(M.slice(0));let i=!1,e=[];if(t.customMatrix&&t.customMatrix.length===9){const w=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],I=E(w);if(I){const g=t.wbGains?t.wbGains[0]:1,s=t.wbGains?t.wbGains[1]:1,v=V(I,[[g,0,0],[0,1,0],[0,0,s]]),r=V(X,v);e=[r[0][0],r[0][1],r[0][2],r[1][0],r[1][1],r[1][2],r[2][0],r[2][1],r[2][2]],i=!0}else throw new Error("Custom Matrix is not invertible.")}const c={outputBps:16,noAutoBright:!0,bright:i?1:Math.pow(2,t.exposure)};t.blackLevel&&t.blackLevel.length===4&&(c.userBlack=0,c.userCblack=t.blackLevel.map(w=>{const I=Math.round(w);return I===0?1:I})),t.demosaicMethod===-1?c.noInterpolation=!0:c.userQual=t.demosaicMethod,i?(c.outputColor=0,c.gamma=[1,1],c.userMul=[1,1,1,1],c.useCameraWb=!1):(c.outputColor=1,c.useCameraWb=!0),await a.open(u,c);const p=await a.imageData(),y=new ImageData(p.width,p.height),d=y.data,m=new Uint16Array(p.data.buffer,p.data.byteOffset,p.data.byteLength/2);if(i&&e.length===9){const w=e,g=Math.pow(2,t.exposure)*.25;for(let s=0;s<m.length;s+=3){const x=m[s]/65535,v=m[s+1]/65535,r=m[s+2]/65535;let b=w[0]*x+w[1]*v+w[2]*r,G=w[3]*x+w[4]*v+w[5]*r,R=w[6]*x+w[7]*v+w[8]*r;b*=g,G*=g,R*=g,b=Math.max(0,Math.min(1,b)),G=Math.max(0,Math.min(1,G)),R=Math.max(0,Math.min(1,R)),b=z(b),G=z(G),R=z(R);const f=s/3*4;d[f]=Math.round(b*255),d[f+1]=Math.round(G*255),d[f+2]=Math.round(R*255),d[f+3]=255}}else for(let w=0;w<m.length;w+=3){const I=w/3*4;d[I]=m[w]>>8,d[I+1]=m[w+1]>>8,d[I+2]=m[w+2]>>8,d[I+3]=255}return y}finally{a.delete?a.delete():a.close()}}async function Q(M,t){const l=await F(),a=new l;try{await a.open(new Uint8Array(M));let u=16383;try{const s=await a.metadata(!0);s&&s.white_level&&(u=s.white_level)}catch(s){console.warn("Metadata error",s)}const i=a.getRawImage(),e=i.width,c=i.height,p=i.data,y=new ImageData(e,c),d=y.data,m=t.blackLevel||[0,0,0,0],w=u,I=t.wbGains?t.wbGains[0]:1,g=t.wbGains?t.wbGains[1]:1;for(let s=0;s<c;s++){const x=s%2;for(let v=0;v<e;v++){const r=v%2,b=x*2+r,G=p[s*e+v],R=m[b];let f=(G-R)/(w-R);f=Math.max(0,Math.min(1,f)),t.exposure!==0&&(f*=Math.pow(2,t.exposure),f=Math.min(1,f)),b===0?f*=I:b===3&&(f*=g);const B=Math.round(z(Math.min(1,f))*255),A=(s*e+v)*4;d[A]=B,d[A+1]=B,d[A+2]=B,d[A+3]=255}}return y}finally{a.delete?a.delete():a.close()}}async function Y(M,t){const l=await F(),a=new l;try{await a.open(new Uint8Array(M));let u=16383;try{const h=await a.metadata(!0);h&&h.white_level&&(u=h.white_level)}catch{}const i=a.getRawImage(),{width:e,height:c,data:p}=i,y=new ImageData(e,c),d=y.data,m=t.blackLevel||[0,0,0,0],w=u,I=t.wbGains?t.wbGains[0]:1,g=t.wbGains?t.wbGains[1]:1,s=Math.pow(2,t.exposure);let x=[[1,0,0],[0,1,0],[0,0,1]];if(t.customMatrix&&t.customMatrix.length===9){const h=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],L=E(h);L&&(x=V(X,L))}const v=x[0][0],r=x[0][1],b=x[0][2],G=x[1][0],R=x[1][1],f=x[1][2],B=x[2][0],A=x[2][1],S=x[2][2],n=new Float32Array(e*c);for(let h=0;h<e*c;h++){const L=Math.floor(h/e),J=h%e,C=L%2,k=J%2,o=C*2+k,_=p[h],O=m[o];let D=(_-O)/(w-O);D=Math.max(0,D),o===0?D*=I:o===3&&(D*=g),n[h]=D}for(let h=1;h<c-1;h++){const L=h%2,J=h*e;for(let C=1;C<e-1;C++){const k=C%2,o=J+C;let _=0,O=0,D=0;!L&&!k?(_=n[o],O=(n[o-1]+n[o+1]+n[o-e]+n[o+e])*.25,D=(n[o-e-1]+n[o-e+1]+n[o+e-1]+n[o+e+1])*.25):L&&k?(D=n[o],O=(n[o-1]+n[o+1]+n[o-e]+n[o+e])*.25,_=(n[o-e-1]+n[o-e+1]+n[o+e-1]+n[o+e+1])*.25):(O=n[o],!L&&k?(_=(n[o-1]+n[o+1])*.5,D=(n[o-e]+n[o+e])*.5):(D=(n[o-1]+n[o+1])*.5,_=(n[o-e]+n[o+e])*.5));let U=v*_+r*O+b*D,j=G*_+R*O+f*D,W=B*_+A*O+S*D;U*=s,j*=s,W*=s,U=Math.max(0,Math.min(1,U)),j=Math.max(0,Math.min(1,j)),W=Math.max(0,Math.min(1,W)),U=z(U),j=z(j),W=z(W);const Z=o*4;d[Z]=Math.round(U*255),d[Z+1]=Math.round(j*255),d[Z+2]=Math.round(W*255),d[Z+3]=255}}return y}finally{a.delete?a.delete():a.close()}}async function q(M,t){const l=await F(),a=new l;try{await a.open(new Uint8Array(M));let u=16383;try{const r=await a.metadata(!0);r&&r.white_level&&(u=r.white_level)}catch(r){console.warn("Metadata error",r)}const i=a.getRawImage(),{width:e,height:c,data:p}=i,y=new ImageData(e,c),d=y.data;if(!t.advancedZeroDep)throw new Error("Missing advanced settings");const{bl:m,bg:w,fg:I}=t.advancedZeroDep,g=w.map((r,b)=>Math.max(0,r-m[b])),s=I.map((r,b)=>Math.max(0,r-m[b])),x=(g[1]+g[3])/2,v=(s[1]+s[3])/2;for(let r=0;r<c;r++){const b=r%2;for(let G=0;G<e;G++){const R=G%2;let f=0;!b&&!R?f=0:!b&&R?f=1:b&&!R?f=3:f=2;const B=p[r*e+G],A=m[f],S=g[f],n=s[f],h=Math.max(B-A,0),L=n-S||1e-9,J=(h-S)/L;let C;J<0?C=h*(x/Math.max(S,1e-9)):J>1?C=h*(v/Math.max(n,1e-9)):C=(1-J)*x+J*v;let k=C/u;k=Math.max(0,Math.min(1,k));const o=Math.round(z(k)*255),_=(r*e+G)*4;d[_]=o,d[_+1]=o,d[_+2]=o,d[_+3]=255}}return y}finally{a.delete?a.delete():a.close()}}self.onmessage=async M=>{const{buffer:t,settings:l}=M.data;try{let a;l.renderMode==="zero-dependency"?a=await Q(t,l):l.renderMode==="advanced-zero-dep"?a=await q(t,l):l.renderMode==="zero-dep-color"?a=await Y(t,l):a=await P(t,l),self.postMessage({success:!0,imageData:a},[a.data.buffer])}catch(a){self.postMessage({success:!1,error:a.message})}};
