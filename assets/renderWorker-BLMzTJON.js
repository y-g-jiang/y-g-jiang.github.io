function E(M){const[[t,l,a],[m,i,e],[n,b,y]]=M,w=t*(i*y-e*b)-l*(m*y-e*n)+a*(m*b-i*n);if(Math.abs(w)<1e-10)return null;const u=1/w;return[[(i*y-e*b)*u,(a*b-l*y)*u,(l*e-a*i)*u],[(e*n-m*y)*u,(t*y-a*n)*u,(a*m-t*e)*u],[(m*b-i*n)*u,(l*n-t*b)*u,(t*i-l*m)*u]]}function V(M,t){const l=[[0,0,0],[0,0,0],[0,0,0]];for(let a=0;a<3;a++)for(let m=0;m<3;m++)for(let i=0;i<3;i++)l[a][m]+=M[a][i]*t[i][m];return l}let T=null;async function F(){if(!T)try{const a=(await import("./joraw-DBDL-TL5.js")).default;if(typeof a!="function")throw new Error("JoRaw WASM import failed");const m=new URL("/assets/joraw-BUh50ws_.wasm",import.meta.url).href;T=a({locateFile:(i,e)=>i.endsWith("joraw.wasm")?m:e+i})}catch(l){throw console.error("Failed to load joraw.js:",l),l}const M=await T,t=M.LibRaw||M.JoRaw;if(!t)throw new Error("JoRaw class not found");return t}const X=[[3.2404542,-1.5371385,-.4985314],[-.969266,1.8760108,.041556],[.0556434,-.2040259,1.0572252]],z=M=>M<=.0031308?12.92*M:1.055*Math.pow(M,1/2.4)-.055;async function P(M,t){const l=await F(),a=new l;try{const m=new Uint8Array(M.slice(0));let i=!1,e=[];if(t.customMatrix&&t.customMatrix.length===9){const s=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],x=E(s);if(x){const g=t.wbGains?t.wbGains[0]:1,d=t.wbGains?t.wbGains[1]:1,I=V(x,[[g,0,0],[0,1,0],[0,0,d]]),f=V(X,I);e=[f[0][0],f[0][1],f[0][2],f[1][0],f[1][1],f[1][2],f[2][0],f[2][1],f[2][2]],i=!0}else throw new Error("Custom Matrix is not invertible.")}const n={outputBps:16,noAutoBright:!0,bright:i?1:Math.pow(2,t.exposure)};t.blackLevel&&t.blackLevel.length===4&&(n.userBlack=0,n.userCblack=t.blackLevel.map(s=>{const x=Math.round(s);return x===0?1:x})),t.demosaicMethod===-1?n.noInterpolation=!0:n.userQual=t.demosaicMethod,i?(n.outputColor=0,n.gamma=[1,1],n.userMul=[1,1,1,1],n.useCameraWb=!1):(n.outputColor=1,n.useCameraWb=!0),await a.open(m,n);const b=await a.imageData(),y=new ImageData(b.width,b.height),w=y.data,u=new Uint16Array(b.data.buffer,b.data.byteOffset,b.data.byteLength/2);if(i&&e.length===9){const s=e,g=Math.pow(2,t.exposure)*.25;for(let d=0;d<u.length;d+=3){const c=u[d]/65535,I=u[d+1]/65535,f=u[d+2]/65535;let G=s[0]*c+s[1]*I+s[2]*f,p=s[3]*c+s[4]*I+s[5]*f,R=s[6]*c+s[7]*I+s[8]*f;G*=g,p*=g,R*=g,G=Math.max(0,Math.min(1,G)),p=Math.max(0,Math.min(1,p)),R=Math.max(0,Math.min(1,R)),G=z(G),p=z(p),R=z(R);const v=d/3*4;w[v]=Math.round(G*255),w[v+1]=Math.round(p*255),w[v+2]=Math.round(R*255),w[v+3]=255}}else for(let s=0;s<u.length;s+=3){const x=s/3*4;w[x]=u[s]>>8,w[x+1]=u[s+1]>>8,w[x+2]=u[s+2]>>8,w[x+3]=255}return y}finally{a.delete?a.delete():a.close()}}async function Q(M,t){const l=await F(),a=new l;try{await a.open(new Uint8Array(M));let m=16383;try{const d=await a.metadata(!0);d&&d.white_level&&(m=d.white_level)}catch(d){console.warn("Metadata error",d)}const i=a.getRawImage(),e=i.width,n=i.height,b=i.data,y=new ImageData(e,n),w=y.data,u=t.blackLevel||[0,0,0,0],s=m,x=t.wbGains?t.wbGains[0]:1,g=t.wbGains?t.wbGains[1]:1;for(let d=0;d<n;d++){const c=d%2;for(let I=0;I<e;I++){const f=I%2,G=c*2+f,p=b[d*e+I],R=u[G];let v=(p-R)/(s-R);v=Math.max(0,Math.min(1,v)),t.exposure!==0&&(v*=Math.pow(2,t.exposure),v=Math.min(1,v)),G===0?v*=x:G===3&&(v*=g);const k=Math.round(z(Math.min(1,v))*255),O=(d*e+I)*4;w[O]=k,w[O+1]=k,w[O+2]=k,w[O+3]=255}}return y}finally{a.delete?a.delete():a.close()}}async function Y(M,t){const l=await F(),a=new l;try{await a.open(new Uint8Array(M));let m=16383;try{const h=await a.metadata(!0);h&&h.white_level&&(m=h.white_level)}catch{}const i=a.getRawImage(),{width:e,height:n,data:b}=i,y=new ImageData(e,n),w=y.data,u=t.blackLevel||[0,0,0,0],s=m,x=t.wbGains?t.wbGains[0]:1,g=t.wbGains?t.wbGains[1]:1,d=Math.pow(2,t.exposure);let c=[[1,0,0],[0,1,0],[0,0,1]];if(t.customMatrix&&t.customMatrix.length===9){const h=[[t.customMatrix[0],t.customMatrix[1],t.customMatrix[2]],[t.customMatrix[3],t.customMatrix[4],t.customMatrix[5]],[t.customMatrix[6],t.customMatrix[7],t.customMatrix[8]]],_=E(h);_&&(c=V(X,_))}const I=c[0][0],f=c[0][1],G=c[0][2],p=c[1][0],R=c[1][1],v=c[1][2],k=c[2][0],O=c[2][1],S=c[2][2],r=new Float32Array(e*n);for(let h=0;h<e*n;h++){const _=Math.floor(h/e),B=h%e,C=_%2,L=B%2,o=C*2+L,A=b[h],J=u[o];let D=(A-J)/(s-J);D=Math.max(0,D),o===0?D*=x:o===3&&(D*=g),r[h]=D}for(let h=1;h<n-1;h++){const _=h%2,B=h*e;for(let C=1;C<e-1;C++){const L=C%2,o=B+C;let A=0,J=0,D=0;!_&&!L?(A=r[o],J=(r[o-1]+r[o+1]+r[o-e]+r[o+e])*.25,D=(r[o-e-1]+r[o-e+1]+r[o+e-1]+r[o+e+1])*.25):_&&L?(D=r[o],J=(r[o-1]+r[o+1]+r[o-e]+r[o+e])*.25,A=(r[o-e-1]+r[o-e+1]+r[o+e-1]+r[o+e+1])*.25):(J=r[o],!_&&L?(A=(r[o-1]+r[o+1])*.5,D=(r[o-e]+r[o+e])*.5):(D=(r[o-1]+r[o+1])*.5,A=(r[o-e]+r[o+e])*.5));let U=I*A+f*J+G*D,j=p*A+R*J+v*D,W=k*A+O*J+S*D;U*=d,j*=d,W*=d,U=Math.max(0,Math.min(1,U)),j=Math.max(0,Math.min(1,j)),W=Math.max(0,Math.min(1,W)),U=z(U),j=z(j),W=z(W);const Z=o*4;w[Z]=Math.round(U*255),w[Z+1]=Math.round(j*255),w[Z+2]=Math.round(W*255),w[Z+3]=255}}return y}finally{a.delete?a.delete():a.close()}}async function q(M,t){const l=await F(),a=new l;try{await a.open(new Uint8Array(M));let m=16383;try{const c=await a.metadata(!0);c&&c.white_level&&(m=c.white_level)}catch(c){console.warn("Metadata error",c)}const i=a.getRawImage(),{width:e,height:n,data:b}=i,y=new ImageData(e,n),w=y.data;if(!t.advancedZeroDep)throw new Error("Missing advanced settings");const{bl:u,bg:s,fg:x}=t.advancedZeroDep,g=(s[1]+s[3])/2,d=(x[1]+x[3])/2;for(let c=0;c<n;c++){const I=c%2;for(let f=0;f<e;f++){const G=f%2;let p=0;!I&&!G?p=0:!I&&G?p=1:I&&!G?p=3:p=2;const R=b[c*e+f],v=u[p],k=s[p],O=x[p],S=Math.max(R-v,0),r=O-k||1e-9,h=(S-k)/r;let _;h<0?_=S*(g/Math.max(k,1e-9)):h>1?_=S*(d/Math.max(O,1e-9)):_=(1-h)*g+h*d;let B=_/m;B=Math.max(0,Math.min(1,B));const C=Math.round(z(B)*255),L=(c*e+f)*4;w[L]=C,w[L+1]=C,w[L+2]=C,w[L+3]=255}}return y}finally{a.delete?a.delete():a.close()}}self.onmessage=async M=>{const{buffer:t,settings:l}=M.data;try{let a;l.renderMode==="zero-dependency"?a=await Q(t,l):l.renderMode==="advanced-zero-dep"?a=await q(t,l):l.renderMode==="zero-dep-color"?a=await Y(t,l):a=await P(t,l),self.postMessage({success:!0,imageData:a},[a.data.buffer])}catch(a){self.postMessage({success:!1,error:a.message})}};
