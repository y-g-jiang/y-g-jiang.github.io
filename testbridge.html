<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ExifTool è¿œç¨‹è¯»å–å™¨</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial; padding: 40px; max-width: 900px; margin: 0 auto; }
h1 { color: #333; }
.controls { margin: 20px 0; }
button { padding: 12px 24px; font-size: 14px; cursor: pointer; margin: 5px; border: none; border-radius: 4px; background: #007bff; color: white; }
button:disabled { background: #ccc; cursor: not-allowed; }
.file-info { padding: 10px; background: #e7f3ff; margin: 10px 0; border-radius: 4px; }
#result { margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; display: none; max-height: 600px; overflow-y: auto; }
.error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
#statusBar { padding: 15px; margin-bottom: 20px; border-radius: 4px; font-weight: bold; }
.connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
</style>
</head>
<body>
<h1>ğŸ› ï¸ ExifTool è¿œç¨‹è¯»å–å™¨</h1>

<div id="statusBar" class="disconnected">
  <span id="statusIcon">âŒ</span>
  <span id="statusText">ğŸ”´ æœªæ£€æµ‹åˆ°æœ¬åœ°æ¡¥æ¢æœåŠ¡</span>
  <div style="margin-top: 10px; font-size: 14px; font-weight: normal;">
    è¯·è¿è¡Œ <code>jiangbridge.exe</code> ååˆ·æ–°é¡µé¢
  </div>
</div>

<div class="controls">
  <input type="file" id="fileInput" style="display:none" />
  <button onclick="document.getElementById('fileInput').click()" id="selectBtn" disabled>ğŸ“ é€‰æ‹©æ–‡ä»¶</button>
  <button onclick="readMetadata()" id="readBtn" disabled>ğŸ” è¯»å–å…ƒæ•°æ®</button>
</div>

<div id="fileInfo" class="file-info" style="display:none"></div>
<div id="result"></div>

<script>
const LOCAL_API = 'http://localhost:5789';  // âœ… ç«¯å£5789
const resultDiv = document.getElementById('result');
const statusBar = document.getElementById('statusBar');
const statusIcon = document.getElementById('statusIcon');
const statusText = document.getElementById('statusText');
const selectBtn = document.getElementById('selectBtn');
const readBtn = document.getElementById('readBtn');
const fileInfo = document.getElementById('fileInfo');

let isConnected = false;
let selectedFile = null;

// æ£€æµ‹è¿æ¥
async function checkConnection() {
    try {
        const response = await fetch(`${LOCAL_API}/health`, { method: 'GET' });
        if (response.ok) {
            const data = await response.json();
            updateStatus(true, `ğŸŸ¢ æ¡¥æ¢æœåŠ¡å·²è¿æ¥ (${data.exiftool})`);
            isConnected = true;
        } else {
            updateStatus(false, 'ğŸ”´ æœåŠ¡å“åº”å¼‚å¸¸');
            isConnected = false;
        }
    } catch (error) {
        updateStatus(false, 'ğŸ”´ æœªè¿è¡Œjiangbridge.exe');
        isConnected = false;
    }
}

function updateStatus(connected, message) {
    statusBar.className = connected ? 'connected' : 'disconnected';
    statusIcon.textContent = connected ? 'âœ…' : 'âŒ';
    statusText.textContent = message;
    selectBtn.disabled = !connected;
    readBtn.disabled = !connected;
}

// æ¯2ç§’æ£€æµ‹
setInterval(checkConnection, 2000);
checkConnection();

// æ–‡ä»¶é€‰æ‹©
document.getElementById('fileInput').addEventListener('change', (e) => {
    selectedFile = e.target.files[0];
    if (selectedFile) {
        fileInfo.textContent = `æ–‡ä»¶: ${selectedFile.name} (${(selectedFile.size/1024/1024).toFixed(2)} MB)`;
        fileInfo.style.display = 'block';
        resultDiv.style.display = 'none';
    }
});

// è¯»å–å…ƒæ•°æ®
async function readMetadata() {
    if (!isConnected) return alert('è¯·å…ˆè¿è¡Œjiangbridge.exe');
    if (!selectedFile) return alert('è¯·é€‰æ‹©æ–‡ä»¶');

    resultDiv.textContent = 'â³ æ­£åœ¨è¯»å–...';
    resultDiv.style.display = 'block';
    resultDiv.className = '';

    const form = new FormData();
    form.append('file', selectedFile);

    try {
        const response = await fetch(`${LOCAL_API}/read`, {
            method: 'POST',
            body: form
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.textContent = JSON.stringify(data.data, null, 2);
        } else {
            resultDiv.textContent = `âŒ é”™è¯¯: ${data.error}`;
            resultDiv.className = 'error';
        }
    } catch (error) {
        resultDiv.textContent = `âŒ å¤±è´¥: ${error.message}`;
        resultDiv.className = 'error';
    }
}
</script>
</body>
</html>