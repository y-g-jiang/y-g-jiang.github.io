<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ExifTool è¿œç¨‹è¯»å–å™¨</title>
<style>
body { font-family: Arial; padding: 40px; max-width: 800px; margin: 0 auto; }
button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
#result { margin-top: 20px; padding: 15px; background: #f5f5f5; white-space: pre-wrap; word-wrap: break-word; display: none; }
.error { color: red; background-color: #ffeeee !important; }
#status { padding: 10px; margin-bottom: 20px; border-radius: 5px; }
.connected { background: #d4edda; color: #155724; }
.disconnected { background: #f8d7da; color: #721c24; }
</style>
</head>
<body>
<h1>ExifTool è¿œç¨‹è¯»å–å™¨</h1>

<div id="status" class="disconnected">
  ğŸ”´ æœªæ£€æµ‹åˆ°æœ¬åœ°æ¡¥æ¢æœåŠ¡<br>
  <small>è¯·åœ¨æœ¬æœºè¿è¡Œ <code>server.exe</code> ä»¥å¯ç”¨åŠŸèƒ½</small>
</div>

<input type="file" id="fileInput" style="display:none" />
<button onclick="document.getElementById('fileInput').click()" id="selectBtn" disabled>ğŸ“ é€‰æ‹©æ–‡ä»¶</button>
<button onclick="readMetadata()" id="readBtn" disabled>ğŸ” è¯»å–å…ƒæ•°æ®</button>

<div id="result"></div>

<script>
let apiKey = null;
const resultDiv = document.getElementById('result');
const statusDiv = document.getElementById('status');
const selectBtn = document.getElementById('selectBtn');
const readBtn = document.getElementById('readBtn');

// 1. ä»URLè·å–æ¡¥æ¢å¯†é’¥
function getBridgeKey() {
    const params = new URLSearchParams(window.location.search);
    return params.get('bridge_key');
}

// 2. æ£€æµ‹æ¡¥æ¢æœåŠ¡
async function checkBridge() {
    apiKey = getBridgeKey();
    if (!apiKey) {
        updateStatus(false, 'æœªä»URLè·å–æ¡¥æ¢å¯†é’¥');
        return;
    }

    try {
        const response = await fetch('http://localhost:5096/read', {
            method: 'OPTIONS',
            headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        
        if (response.ok) {
            updateStatus(true, 'æ¡¥æ¢æœåŠ¡å·²è¿æ¥');
            selectBtn.disabled = false;
            readBtn.disabled = false;
        } else {
            updateStatus(false, 'æ¡¥æ¢æœåŠ¡æœªå“åº”');
        }
    } catch (error) {
        updateStatus(false, 'æ— æ³•è¿æ¥æœ¬åœ°æœåŠ¡');
    }
}

function updateStatus(connected, message) {
    statusDiv.className = connected ? 'connected' : 'disconnected';
    statusDiv.innerHTML = connected ? 
        `ğŸŸ¢ ${message}<br><small>ç°åœ¨å¯ä»¥å®‰å…¨è¯»å–æœ¬åœ°æ–‡ä»¶</small>` :
        `ğŸ”´ ${message}<br><small>è¯·åœ¨æœ¬æœºè¿è¡Œ <code>server.exe</code> ååˆ·æ–°é¡µé¢</small>`;
}

// 3. æ–‡ä»¶é€‰æ‹©
let selectedFile = null;
document.getElementById('fileInput').addEventListener('change', (e) => {
    selectedFile = e.target.files[0];
    if (selectedFile) {
        resultDiv.textContent = `å·²é€‰æ‹©: ${selectedFile.name}`;
        resultDiv.style.display = 'block';
        resultDiv.className = '';
    }
});

// 4. è¯»å–å…ƒæ•°æ®
async function readMetadata() {
    if (!selectedFile) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
    }

    resultDiv.textContent = 'æ­£åœ¨è¯»å–å…ƒæ•°æ®...';
    resultDiv.className = '';
    resultDiv.style.display = 'block';

    const form = new FormData();
    form.append('file', selectedFile);

    try {
        const response = await fetch('http://localhost:5096/read', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`
            },
            body: form
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.textContent = JSON.stringify(data.data, null, 2);
        } else {
            resultDiv.textContent = `é”™è¯¯: ${data.error}`;
            resultDiv.className = 'error';
        }
    } catch (error) {
        resultDiv.textContent = `è¿æ¥å¤±è´¥: ${error.message}\n\n1. ç¡®ä¿server.exeæ­£åœ¨è¿è¡Œ\n2. åˆ·æ–°æ­¤é¡µé¢é‡è¯•`;
        resultDiv.className = 'error';
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æµ‹æ¡¥æ¢
checkBridge();
</script>
</body>
</html>